#!/bin/bash
# Git hook: pre-commit â†’ POST GitPreCommit event to observability server

SERVER_URL="${OBSERVABILITY_SERVER:-http://localhost:4000}"
REPO_PATH="$(git rev-parse --show-toplevel 2>/dev/null)"
SESSION_ID="$(echo -n "$REPO_PATH" | shasum -a 256 | cut -c1-36)"
BRANCH="$(git symbolic-ref --short HEAD 2>/dev/null || echo 'detached')"

# Staged files
STAGED_FILES="$(git diff --cached --name-only)"
STAGED_COUNT="$(echo "$STAGED_FILES" | grep -c . || echo 0)"

# Truncate file list for payload (first 20 files)
STAGED_LIST="$(echo "$STAGED_FILES" | head -20 | jq -R . | jq -s .)"

SUMMARY="Pre-commit: ${STAGED_COUNT} file(s) on ${BRANCH}"

# JSON-safe escaping via jq
PAYLOAD="$(jq -n \
  --arg branch "$BRANCH" \
  --argjson staged_file_count "$STAGED_COUNT" \
  --argjson staged_files "$STAGED_LIST" \
  --arg claude_session_id "${CLAUDE_SESSION_ID:-}" \
  '{branch: $branch, staged_file_count: $staged_file_count, staged_files: $staged_files, claude_session_id: $claude_session_id}'
)"

BODY="$(jq -n \
  --arg source_app "git" \
  --arg session_id "$SESSION_ID" \
  --arg hook_event_type "GitPreCommit" \
  --arg summary "$SUMMARY" \
  --argjson payload "$PAYLOAD" \
  '{source_app: $source_app, session_id: $session_id, hook_event_type: $hook_event_type, summary: $summary, payload: $payload}'
)"

curl -s -X POST "${SERVER_URL}/events" \
  -H "Content-Type: application/json" \
  -d "$BODY" \
  --connect-timeout 1 --max-time 2 >/dev/null 2>&1 &

exit 0
